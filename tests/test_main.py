# -*- coding: utf-8 -*-
from __future__ import print_function

import re
import os
import unittest
import traceback
import sys
import json
import pickle

import xml.etree.ElementTree as ET

import responses
from click.testing import CliRunner

from jobs_detector import settings
from jobs_detector.main import jobs_detector

from . import fixtures


class HackerNewsTestCase(unittest.TestCase):

    def setUp(self):
        self.post_id = '11814828'
        fixtures.load_fixtures()

    @responses.activate
    def test_hacker_news_default_keywords(self):
        runner = CliRunner()
        result = runner.invoke(
            jobs_detector,
            ['hacker_news', '-i', self.post_id]
        )

        # Print useful error messages
        if not isinstance(result.exc_info[1], SystemExit) or\
           result.exc_info[1].code != 0:
            excep_type, orig_excep, tb = result.exc_info
            traceback.print_tb(tb)
            raise orig_excep(None, tb)

        with open(os.path.join(settings.BASE_DIR, 'jobs.json')) as f:
            data = json.load(f)

        expected_total = 800
        expected_counts = {'remote': 179,
                           'postgres': 87,
                           'python': 164,
                           'javascript': 131,
                           'react': 143,
                           'pandas': 6}

        self.assertEqual(data['total_jobs'], expected_total)
        self.assertEqual(data['counts'], expected_counts)



        javascript_job = "QA Lead &amp; Core Engineer | Replicated | Los Angeles | $70k - $80k, $130k - $150k both with equity |"
        self.assertTrue(any((job.startswith(javascript_job) for job in data['keywords']['javascript'])))

        
        javascript_job = "QA Lead &amp; Core Engineer | Replicated | Los Angeles | $70k - $80k, $130k - $150k both with equity |"
        self.assertTrue(any((job.startswith(javascript_job) for job in data['keywords']['javascript'])))

    @responses.activate
    def test_hacker_news_custom_keywords(self):
        runner = CliRunner()
        result = runner.invoke(
            jobs_detector,
            ['hacker_news',
             '-i', self.post_id,
             '-k', 'python,django']
        )

        # Print useful error messages
        if not isinstance(result.exc_info[1], SystemExit) or\
           result.exc_info[1].code != 0:
            excep_type, orig_excep, tb = result.exc_info
            
            raise orig_excep(None, tb)

        with open(os.path.join(settings.BASE_DIR, 'jobs.json')) as f:
            data = json.load(f)

        expected_total = 800
        expected_counts = {'python': 164,
                           'django': 39}

        self.assertEqual(data['total_jobs'], expected_total)
        self.assertEqual(data['counts'], expected_counts)

    @responses.activate
    def test_hacker_news_combinations(self):
        runner = CliRunner()
        result = runner.invoke(
            jobs_detector,
            ['hacker_news',
             '-i', self.post_id,
             '-c', 'python-remote,python-django,django-remote']
        )

        # Print useful error messages
        if not isinstance(result.exc_info[1], SystemExit) or\
           result.exc_info[1].code != 0:
            excep_type, orig_excep, tb = result.exc_info
            traceback.print_tb(tb)
            raise orig_excep(None, tb)

        with open(os.path.join(settings.BASE_DIR, 'jobs.json')) as f:
            data = json.load(f)

        expected_total = 800
        expected_counts = {'remote': 179,
                           'postgres': 87,
                           'python': 164,
                           'javascript': 131,
                           'react': 143,
                           'pandas': 6,
                           'python-remote': 33,
                           'django-remote': 8,
                           'python-django': 38}

        self.assertEqual(data['total_jobs'], expected_total)
        self.assertEqual(data['counts'], expected_counts)

    @responses.activate
    def test_hacker_news_keywords_and_combinations(self):
        runner = CliRunner()
        result = runner.invoke(
            jobs_detector,
            ['hacker_news',
             '-i', self.post_id,
             '-k', 'python,django',
             '-c', 'python-remote,python-django,django-remote']
        )

        # Print useful error messages
        if not isinstance(result.exc_info[1], SystemExit) or\
           result.exc_info[1].code != 0:
            excep_type, orig_excep, tb = result.exc_info
            traceback.print_tb(tb)
            raise orig_excep(None, tb)

        with open(os.path.join(settings.BASE_DIR, 'jobs.json')) as f:
            data = json.load(f)

        expected_total = 800
        expected_counts = {'python': 164,
                           'django': 39,
                           'python-remote': 33,
                           'django-remote': 8,
                           'python-django': 38}

        self.assertEqual(data['total_jobs'], expected_total)
        self.assertEqual(data['counts'], expected_counts)

"""
    @responses.activate
    def test_hacker_news_pickle(self):
        runner = CliRunner()
        result = runner.invoke(
            jobs_detector,
            ['hacker_news', '-i', self.post_id, '-o', 'pickle']
        )

        # Print useful error messages
        if not isinstance(result.exc_info[1], SystemExit) or\
           result.exc_info[1].code != 0:
            excep_type, orig_excep, tb = result.exc_info
            
            raise orig_excep(None, tb)

        with open(os.path.join(settings.BASE_DIR, 'jobs.pickle'), 'rb') as f:
            data = pickle.load(f)

        expected_total = 800
        expected_counts = {'remote': 179,
                           'postgres': 87,
                           'python': 164,
                           'javascript': 131,
                           'react': 143,
                           'pandas': 6}

        self.assertEqual(data['total_jobs'], expected_total)
        self.assertEqual(data['counts'], expected_counts)

    @responses.activate
    def test_hacker_news_xml(self):
        runner = CliRunner()
        result = runner.invoke(
            jobs_detector,
            ['hacker_news', '-i', self.post_id, '-o', 'xml']
        )

        # Print useful error messages
        if not isinstance(result.exc_info[1], SystemExit) or\
           result.exc_info[1].code != 0:
            excep_type, orig_excep, tb = result.exc_info
            
            raise orig_excep(None, tb)

        xmlfile = os.path.join(settings.BASE_DIR, 'jobs.xml')
        tree = ET.parse(xmlfile)
        job_search = tree.getroot()

        with open(os.path.join(settings.BASE_DIR, 'jobs.pickle'), 'rb') as f:
            data = pickle.load(f)

        expected_total = 800
        expected_counts = {'remote': 179,
                           'postgres': 87,
                           'python': 164,
                           'javascript': 131,
                           'react': 143,
                           'pandas': 6}
        summary = job_search.find('summary')

        self.assertEqual(int(summary.find('total_jobs').text), expected_total)
        for cnt in summary.findall('count'):
            self.assertEqual(int(cnt.text), expected_counts[cnt.get('name')])
"""
